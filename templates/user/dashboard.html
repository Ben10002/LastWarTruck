{% extends "base.html" %}

{% block title %}Dashboard - LKW Bot{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Welcome, {{ user.email }}!</h2>
    
    <!-- Success/Error Messages -->
    {% if request.args.get('success') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {% if request.args.get('success') == 'bot_started' %}
            ‚úÖ Bot started successfully!
        {% elif request.args.get('success') == 'bot_stopped' %}
            ‚èπÔ∏è Bot stopped successfully!
        {% elif request.args.get('success') == 'config_saved' %}
            üíæ Configuration saved successfully!
        {% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    {% if request.args.get('error') %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {% if request.args.get('error') == 'no_subscription' %}
            ‚ö†Ô∏è You need an active subscription to start the bot!
        {% elif request.args.get('error') == 'not_configured' %}
            ‚ö†Ô∏è Bot not configured yet! Please contact admin.
        {% elif request.args.get('error') == 'already_running' %}
            ‚ö†Ô∏è Bot is already running!
        {% elif request.args.get('error') == 'not_running' %}
            ‚ö†Ô∏è Bot is not running!
        {% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    <div class="row">
        <!-- Left Column -->
        <div class="col-md-6">
            
            <!-- Subscription Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">üìÖ Subscription Status</h5>
                </div>
                <div class="card-body">
                    {% if subscription and subscription.is_active %}
                        <div class="alert alert-success mb-0">
                            <strong>‚úÖ Active</strong><br>
                            Expires: {{ subscription.expires_at.strftime('%Y-%m-%d %H:%M') }}
                        </div>
                    {% else %}
                        <div class="alert alert-danger mb-0">
                            <strong>‚ùå No Active Subscription</strong><br>
                            <a href="{{ url_for('dashboard.licenses') }}" class="btn btn-primary btn-sm mt-2">Redeem License Key</a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Bot Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">ü§ñ Bot Status</h5>
                </div>
                <div class="card-body">
                    {% if bot_config.is_running %}
                        <div class="alert alert-success mb-3">
                            <strong>‚úÖ Bot is running</strong>
                        </div>
                        
                        <!-- Live Timer -->
                        <div class="mb-3">
                            <strong>‚è±Ô∏è Running Time:</strong>
                            <span id="runningTimer" class="badge bg-primary" style="font-size: 1.1em;">00:00:00</span>
                        </div>
                        
                        {% if bot_config.running_timer_enabled %}
                        <div class="mb-3">
                            <strong>‚è∞ Auto-Stop:</strong>
                            <span class="badge bg-warning">After {{ bot_config.running_timer_minutes }} minutes</span>
                        </div>
                        {% endif %}
                        
                        <form method="POST" action="{{ url_for('dashboard.stop_bot') }}">
                            <button type="submit" class="btn btn-danger btn-lg w-100">
                                ‚èπÔ∏è Stop Bot
                            </button>
                        </form>
                    {% else %}
                        <div class="alert alert-secondary mb-3">
                            <strong>‚è∏Ô∏è Bot is stopped</strong>
                        </div>
                        
                        <form method="POST" action="{{ url_for('dashboard.start_bot') }}">
                            <button type="submit" class="btn btn-success btn-lg w-100" 
                                    {% if not subscription or not subscription.is_active %}disabled{% endif %}
                                    {% if not bot_config.is_configured %}disabled{% endif %}>
                                ‚ñ∂Ô∏è Start Bot
                            </button>
                        </form>
                        
                        {% if not subscription or not subscription.is_active %}
                        <small class="text-muted d-block mt-2">‚ö†Ô∏è Active subscription required</small>
                        {% elif not bot_config.is_configured %}
                        <small class="text-muted d-block mt-2">‚ö†Ô∏è Bot configuration required</small>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            
            <!-- Bot Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">‚öôÔ∏è Bot Settings</h5>
                </div>
                <div class="card-body">
                    <p><strong>Share Mode:</strong> 
                        {% if bot_config.share_alliance %}
                            <span class="badge bg-primary">Alliance</span>
                        {% elif bot_config.share_world %}
                            <span class="badge bg-info">World Chat</span>
                        {% else %}
                            <span class="badge bg-secondary">Not Set</span>
                        {% endif %}
                    </p>
                    
                    <p><strong>Truck Strength Limit:</strong> 
                        <span class="badge bg-success">‚â§ {{ bot_config.truck_strength }}M</span>
                    </p>
                    
                    {% if bot_config.server_restriction_enabled %}
                    <p><strong>Server Restriction:</strong> 
                        <span class="badge bg-warning">Server #{{ bot_config.server_restriction_value }}</span>
                    </p>
                    {% endif %}
                    
                    <a href="{{ url_for('dashboard.configure_bot') }}" class="btn btn-primary w-100">
                        üìù Configure Bot
                    </a>
                </div>
            </div>
            
        </div>
        
        <!-- Right Column -->
        <div class="col-md-6">
            
            <!-- Bot Logs -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìã Recent Logs</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                        üîÑ Refresh
                    </button>
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    {% if bot_logs %}
                        <table class="table table-sm">
                            <tbody>
                                {% for log in bot_logs %}
                                <tr>
                                    <td style="white-space: nowrap;">
                                        <small class="text-muted">{{ log.timestamp.strftime('%H:%M:%S') }}</small>
                                    </td>
                                    <td>
                                        {% if log.level == 'error' %}
                                            <span class="badge bg-danger">ERROR</span>
                                        {% elif log.level == 'warning' %}
                                            <span class="badge bg-warning">WARNING</span>
                                        {% elif log.level == 'success' %}
                                            <span class="badge bg-success">SUCCESS</span>
                                        {% else %}
                                            <span class="badge bg-info">INFO</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ log.message }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted mb-0">No logs yet. Start the bot to see activity!</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quick Links -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üîó Quick Links</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('dashboard.licenses') }}" class="btn btn-outline-primary">
                            üé´ Manage Licenses
                        </a>
                        <a href="{{ url_for('dashboard.schedule') }}" class="btn btn-outline-info">
                            üìÖ Bot Scheduler
                        </a>
                        <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-secondary">
                            üö™ Logout
                        </a>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<!-- JavaScript for Live Timer -->
{% if bot_config.is_running and bot_start_timestamp %}
<script>
    // Get bot start time from server
    const botStartTime = {{ bot_start_timestamp }};
    
    function updateTimer() {
        const now = Date.now();
        const elapsed = Math.floor((now - botStartTime) / 1000); // seconds
        
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;
        
        const timeString = 
            String(hours).padStart(2, '0') + ':' +
            String(minutes).padStart(2, '0') + ':' +
            String(seconds).padStart(2, '0');
        
        document.getElementById('runningTimer').textContent = timeString;
    }
    
    // Update every second
    setInterval(updateTimer, 1000);
    updateTimer(); // Initial call
</script>
{% elif bot_config.is_running %}
<script>
    // Fallback if no timestamp
    document.getElementById('runningTimer').textContent = "Running...";
</script>
{% endif %}
{% endblock %}